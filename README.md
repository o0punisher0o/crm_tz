# Mini CRM — распределение лидов между операторами

Мини-CRM для автоматического распределения обращений (контактов) между операторами с учётом:
- активности оператора,
- лимита нагрузки,
- индивидуальных весов для каждого источника,
- уникальности лида по external_id.

Проект реализован на FastAPI + SQLAlchemy + SQLite.

---

## Запуск проекта

1. Установить зависимости:
pip install -r requirements.txt

2. Запустить сервер:
uvicorn app.main:app --reload

3. API будет доступно по адресу:
http://localhost:8000

4. Swagger UI:
http://localhost:8000/docs

---

## Сущности

### Operator
- Имя
- Активность (active)
- Лимит нагрузки (load_limit)
- Текущие контакты

### Lead
- Уникальный external_id
- Связанные контакты

### Source
- Канал (бот/источник)
- Таблица SourceOperatorWeight — привязка операторов с весами

### Contact
- Обращение
- Связан с Lead, Source, Operator

---

## Модель распределения

### 1. Определение лида
Лид ищется по `external_id`.  
Если нет — создаётся.

### 2. Фильтрация операторов
Из операторов, связанных с источником, выбираются:
- только активные,
- только те, у кого нагрузка (контакты за 24 часа) < лимит.

### 3. Распределение по весам
Используется взвешенный случайный выбор:

Вероятность = weight / сумма_весов

Если оператор при выборе перегружен — выбирается следующий.

Если подходящих нет → создаётся контакт без оператора.

---

## Основные эндпоинты

### Операторы
POST /operators — создать  
GET /operators — список  
PATCH /operators/{id} — изменить  

### Источники
POST /sources — создать  
POST /sources/{id}/weights — задать веса операторов  
GET /sources — список  

### Лиды
GET /leads — список  
GET /leads/{id} — один лид  

### Контакты
POST /contacts — создать обращение  
GET /contacts — список  

---

## Пример запроса на создание обращения

POST /contacts
{
"external_id": "user123",
"source_id": 1
}

Ответ:
{
"contact_id": 12,
"lead_id": 5,
"source_id": 1,
"assigned_operator": 2
}

---

## Описание логики нагрузки
Нагрузка = количество контактов, созданных оператору за последние 24 часа.

Если нагрузка >= load_limit, оператор исключается из распределения.

---

## Что произойдёт, если нет подходящих операторов?
Контакт создаётся с `operator_id = null`.  
Это видно в GET /contacts.